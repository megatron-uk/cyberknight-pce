# Cyber Knight Asset Bank Details

Many of these details are provided by *Elmer* from *PCEngineFX.com* following a discussion (http://www.pcenginefx.com/forums/index.php?topic=16222.165) relating to the issues of English text overflowing in to 'unused' space in the ROM, following insertion of longer script text.

The options were to then fall back to fixed-length strings (which would result in truncated English text) or look at expanding the ROM size to allocate more space at the end for expanded dialogue.

*Elmer* found that the game does use a text block pointer system. Two tables loaded in bank 0x01 which point to the asset bank to load, and an offset in to that bank. Each asset bank then has a small table at the front with pointers then in to the data structures that follow. Asset banks are 16KB in size.

Here follows a break down of the text/asset bank system:

## Master Bank

Master Bank 0x01, it is always loaded at PCE memory address 0xC000-0xDFFF.

**Table A**

- Table A, ROM offset 0x02939, is a table of Asset Bank pointers
- This is a table of which Text Bank to load at any point.

*Data*
```
0e 0e 0e 0e 0e 0e 0c 0e
0e 00 00 00 00 00 00 00
14 0a 0a 0a 0a 0a 0c 0c
0c 0c 0c 0c 0c 0c 0c 0c
0c
```

There are 33 bank load addresses, many of which, as shown, are duplicates.


**Table B**

- Table B, ROM offset 0x0295a, type, Script Offset pointers.
- This is a table of offsets into the pointer tables at the start of each asset bank.

*Data*
```
01 03 05 07 09 0b 17 0d
0f 00 00 00 00 00 00 00
83 01 03 05 07 09 01 03
05 07 09 0b 0d 0f 11 13
15
```

There are 33 asset chunk pointer offset addresses, one for each of the bank load entries in Table A.

## Asset Banks

Asset banks contain game script and graphics. They are indexed by a leading table of (a variable number of) 16bit pointers in to the bank, followed by data. The below text banks are always loaded at PCE memory address 0x4000-0x7FFF.

**Important:** The index pointers in the table of each asset bank are stored in *little endian* format. Don't do like I did and assume they're big endian...

### Bank 0x0A, - 0x0B

- Text Bank $0A/$0B, 
- ROM offset $14000-$17FFF
- First byte, Bank number, 0x0A

*Pointer Data*
```
0A 0B 40 FD 54 6F 6A 29
6C C1 75 00
```

*Pointer Table*
```
Index, Pointer Value, ROM Position Calculation, ROM Position
0x01, 40 0B, - 0x4000 + 0x14000, 0x1400B
0x03, 54 FD, - 0x4000 + 0x14000, 0x154FD
0x05, 6A 6F, - 0x4000 + 0x14000, 0x16A6F
0x07, 6C 29, - 0x4000 + 0x14000, 0x16C29
0x09, 75 C1, - 0x4000 + 0x14000, 0x175C1
```

### Bank 0x0C, - 0x0D

- Text Bank $0C/$0D
- ROM offset $18000-$1BFFF
- First byte, Bank number, 0x0C

*Pointer Data*
```
0C 19 40 62 44 61 4C 47
51 27 59 16 5C 4B 63 17
6E A2 6E D5 71 DB 75 CE
78 00
```

*Pointer Table*
```
Index, Pointer Value, ROM Position Calculation, ROM Position
0x01, 40 19, - 0x4000 + 0x18000, 0x18019
0x03, 44 62, - 0x4000 + 0x18000, 0x18462
0x05, 4C 61, - 0x4000 + 0x18000, 0x18C61 
0x07, 51 47, - 0x4000 + 0x18000, 0x19147
0x09, 59 27, - 0x4000 + 0x18000, 0x19927
0x0B, 5C 16, - 0x4000 + 0x18000, 0x19C16
0x0D, 63 4B, - 0x4000 + 0x18000, 0x1A34B
0x0F, 6E 17, - 0x4000 + 0x18000, 0x1AE17
0x11, 6E A2, - 0x4000 + 0x18000, 0x1AEA2
0x13, 71 D5, - 0x4000 + 0x18000, 0x1B1D5
0x15, 75 DB, - 0x4000 + 0x18000, 0x1B5D8
0x17, 78 CE, - 0x4000 + 0x18000, 0x1B8CE
```

### Bank 0x0E, - 0x0F

- Text Bank $0E/$0F
- ROM offset $1C000-$1FFFF
- First byte, Bank number, 0x0E

*Pointer Data*
```
0E 11 40 4C 4B ED 4E 73
53 B2 55 86 5C FF 6B EC
70 00
```

*Pointer Table*
```
Index, Pointer Value, ROM Position Calculation, ROM Position
0x01, 40 11, - 0x4000 + 0x1C000, 0x1C011
0x03, 4B 4C, - 0x4000 + 0x1C000, 0x1CB4C
0x05, 4E ED, - 0x4000 + 0x1C000, 0x1CEED
0x07, 53 73, - 0x4000 + 0x1C000, 0x1D373
0x09, 55 B2, - 0x4000 + 0x1C000, 0x1D5B2
0x0B, 5C 86, - 0x4000 + 0x1C000, 0x1DC86
0x0D, 6B FF, - 0x4000 + 0x1C000, 0x1EBFF
0x0F, 70 EC, - 0x4000 + 0x1C000, 0x1F0EC
```

### Bank 0x14, - 0x15

- Text Bank $14/$15, ROM offset $28000-$2BFFF
- First byte, Bank number, 0x14
- Second byte, 0x93, 147 bytes, 146/2, 73x 2-byte pointers (*INCORRECT, only 66 pointers in this table.*)

*Pointer Data*
```
14 93 6D 95 6D A4 6D 36
6E 65 6E B7 6E 95 6D 0E
6F 95 6D 3D 6F 5E 70 95
6D 84 70 95 6D 93 6D 45
71 71 71 02 72 37 72 B2
72 95 6D 0E 73 DF 73 95
6D 20 74 81 74 AA 74 BD
74 D4 74 93 6D 93 6D 42
75 95 6D 74 75 B4 75 95
6D F7 75 49 76 95 6D 6F
76 F4 76 B4 77 CF 77 CF
77 95 6D 93 6D 93 6D 93
6D 93 6D 93 6D 93 6D 93
6D 93 6D 93 6D 93 6D DA
77 95 6D FA 77 6C 78 C1
78 E4 78 0C 79 93 6D 3D
79 15 6A 85 40 00
```

*Pointer Table*
```
Index, Pointer Value, ROM Position Calculation, ROM Position
0x01, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x03, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x05, 6D A4, - 0x4000 + 0x28000, 0x2ADA4
0x07, 6E 36, - 0x4000 + 0x28000, 0x2AE36
0x09, 6E 65, - 0x4000 + 0x28000, 0x2AE65
0x0b, 6E B7, - 0x4000 + 0x28000, 0x2AEB7
0x0d, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x0f, 6F 0E, - 0x4000 + 0x28000, 0x2AF0E
0x11, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x13, 6F 3D, - 0x4000 + 0x28000, 0x2AF3D
0x15, 70 5E, - 0x4000 + 0x28000, 0x2B05E
0x17, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x19, 70 84, - 0x4000 + 0x28000, 0x2B084
0x1b, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x1d, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x1f, 71 45, - 0x4000 + 0x28000, 0x2B145
0x21, 71 71, - 0x4000 + 0x28000, 0x2B171
0x23, 72 02, - 0x4000 + 0x28000, 0x2B202
0x25, 72 37, - 0x4000 + 0x28000, 0x2B237
0x27, 72 B2, - 0x4000 + 0x28000, 0x2B2B2
0x29, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x2b, 73 0E, - 0x4000 + 0x28000, 0x2B30E
0x2d, 73 DF, - 0x4000 + 0x28000, 0x2B3DF
0x2f, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x31, 74 20, - 0x4000 + 0x28000, 0x2B420
0x33, 74 81, - 0x4000 + 0x28000, 0x2B481
0x35, 74 AA, - 0x4000 + 0x28000, 0x2B4AA
0x37, 74 BD, - 0x4000 + 0x28000, 0x2B4BD
0x39, 74 D4, - 0x4000 + 0x28000, 0x2B4D4
0x3b, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x3d, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x3f, 75 42, - 0x4000 + 0x28000, 0x2B542
0x41, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x43, 75 74, - 0x4000 + 0x28000, 0x2B574
0x45, 75 B4, - 0x4000 + 0x28000, 0x2B5B4
0x47, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x49, 75 F7, - 0x4000 + 0x28000, 0x2B5F7
0x4b, 76 49, - 0x4000 + 0x28000, 0x2B649
0x4d, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x4f, 76 6F, - 0x4000 + 0x28000, 0x2B66F
0x51, 76 F4, - 0x4000 + 0x28000, 0x2B6F4
0x53, 77 B4, - 0x4000 + 0x28000, 0x2B7B4
0x55, 77 CF, - 0x4000 + 0x28000, 0x2B7CF
0x57, 77 CF, - 0x4000 + 0x28000, 0x2B7CF
0x59, 6D 95, - 0x4000 + 0x28000, 0x2AD93
0x5b, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x5d, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x5f, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x61, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x63, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x65, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x67, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x69, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x6b, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x6d, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x6f, 77 DA, - 0x4000 + 0x28000, 0x2B7DA
0x71, 6D 95, - 0x4000 + 0x28000, 0x2AD95
0x73, 77 FA, - 0x4000 + 0x28000, 0x2B7FA
0x75, 78 6C, - 0x4000 + 0x28000, 0x2B86C
0x77, 78 C1, - 0x4000 + 0x28000, 0x2B8C1
0x79, 78 E4, - 0x4000 + 0x28000, 0x288E4
0x7b, 79 0C, - 0x4000 + 0x28000, 0x2B90C
0x7d, 6D 93, - 0x4000 + 0x28000, 0x2AD93
0x7f, 79 3D, - 0x4000 + 0x28000, 0x2B93D
0x81, 6A 15, - 0x4000 + 0x28000, 0x2AA15
0x83, 40 85, - 0x4000 + 0x28000, 0x28085
```